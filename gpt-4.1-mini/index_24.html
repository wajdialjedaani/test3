<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2" />
<title>Accessible Book Recommendation: Personalized Suggestions by Genre & Author</title>
<style>
  /* Reset and base */
  :root {
    --color-primary: #004d99; /* Dark Blue */
    --color-secondary: #ff6f61; /* Coral */
    --color-accent: #009933; /* Green */
    --color-bg: #ffffff;
    --color-text: #1a1a1a;
    --color-error: #cc0000;
    --color-focus: #ffbf47;
    --color-info-bg: #e6f0ff;
    --color-info-text: #004d99;
    --color-border: #cccccc;
    --color-shadow: rgba(0,0,0,0.15);
    --font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    --font-size-base: 1rem;
    --line-height-base: 1.6;
    --max-content-width: 900px;
  }

  /* Respect prefers-reduced-motion */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.001ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.001ms !important;
      scroll-behavior: auto !important;
    }
  }

  /* Base styles */
  body {
    font-family: var(--font-family);
    font-size: var(--font-size-base);
    line-height: var(--line-height-base);
    color: var(--color-text);
    background: var(--color-bg);
    margin: 0;
    padding: 0 1rem 3rem;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  a {
    color: var(--color-primary);
    text-decoration: underline;
  }
  a:focus,
  a:hover {
    outline: 3px solid var(--color-focus);
    outline-offset: 2px;
    text-decoration: none;
  }

  h1, h2, h3 {
    font-weight: 700;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    line-height: 1.2;
  }
  h1 {
    font-size: 2.25rem;
    color: var(--color-primary);
  }
  h2 {
    font-size: 1.75rem;
    color: var(--color-secondary);
  }
  h3 {
    font-size: 1.25rem;
    color: var(--color-accent);
  }

  /* Skip link */
  .skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--color-primary);
    color: var(--color-bg);
    padding: 0.75rem 1rem;
    z-index: 100;
    text-decoration: none;
    font-weight: 700;
    border-radius: 0 0 4px 0;
  }
  .skip-link:focus {
    top: 0;
    outline: 3px solid var(--color-focus);
    outline-offset: 2px;
  }

  /* Container */
  .container {
    max-width: var(--max-content-width);
    width: 100%;
  }

  /* Header */
  header {
    width: 100%;
    padding: 1rem 0;
    border-bottom: 4px solid var(--color-primary);
    background: linear-gradient(90deg, #004d99 0%, #007acc 100%);
    color: var(--color-bg);
    text-align: center;
    box-shadow: 0 2px 6px var(--color-shadow);
  }

  /* Navigation */
  nav[aria-label="Primary"] {
    background-color: var(--color-secondary);
    box-shadow: inset 0 -4px 0 var(--color-primary);
  }
  nav[aria-label="Primary"] ul {
    list-style: none;
    margin: 0;
    padding: 0.5rem 1rem;
    display: flex;
    justify-content: center;
    gap: 1.5rem;
  }
  nav[aria-label="Primary"] a,
  nav[aria-label="Primary"] button {
    color: var(--color-bg);
    background: none;
    border: none;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }
  nav[aria-label="Primary"] a:focus,
  nav[aria-label="Primary"] a:hover,
  nav[aria-label="Primary"] button:focus,
  nav[aria-label="Primary"] button:hover {
    background-color: var(--color-primary);
    outline: none;
  }
  nav[aria-label="Primary"] button[aria-expanded="true"] {
    background-color: var(--color-primary);
  }

  /* Dropdown menu */
  .dropdown {
    position: relative;
  }
  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background: var(--color-bg);
    border: 2px solid var(--color-primary);
    border-radius: 4px;
    box-shadow: 0 4px 10px var(--color-shadow);
    min-width: 12rem;
    z-index: 1000;
    display: none;
  }
  .dropdown-menu[aria-hidden="false"] {
    display: block;
  }
  .dropdown-menu ul {
    list-style: none;
    margin: 0;
    padding: 0.5rem 0;
  }
  .dropdown-menu li {
    margin: 0;
  }
  .dropdown-menu a {
    display: block;
    padding: 0.5rem 1rem;
    color: var(--color-text);
    text-decoration: none;
  }
  .dropdown-menu a:focus,
  .dropdown-menu a:hover {
    background-color: var(--color-info-bg);
    color: var(--color-primary);
    outline: none;
  }

  /* Breadcrumbs */
  nav[aria-label="Breadcrumb"] {
    margin: 1rem 0;
  }
  nav[aria-label="Breadcrumb"] ol {
    list-style: none;
    display: flex;
    gap: 0.5rem;
    padding: 0;
    margin: 0;
    font-size: 0.9rem;
    color: var(--color-primary);
  }
  nav[aria-label="Breadcrumb"] li::after {
    content: "›";
    margin-left: 0.5rem;
    color: var(--color-secondary);
  }
  nav[aria-label="Breadcrumb"] li:last-child::after {
    content: "";
  }
  nav[aria-label="Breadcrumb"] a {
    color: var(--color-primary);
    text-decoration: underline;
  }
  nav[aria-label="Breadcrumb"] a:focus,
  nav[aria-label="Breadcrumb"] a:hover {
    outline: 3px solid var(--color-focus);
    outline-offset: 2px;
    text-decoration: none;
  }

  /* Main content */
  main {
    width: 100%;
    max-width: var(--max-content-width);
  }

  /* Form styles */
  form {
    background-color: var(--color-info-bg);
    border: 3px solid var(--color-primary);
    border-radius: 8px;
    padding: 1.5rem 2rem;
    box-shadow: 0 4px 12px var(--color-shadow);
    margin-bottom: 2rem;
  }
  fieldset {
    border: 2px solid var(--color-secondary);
    border-radius: 6px;
    margin-bottom: 1.5rem;
    padding: 1rem 1.5rem;
  }
  legend {
    font-weight: 700;
    font-size: 1.25rem;
    color: var(--color-secondary);
    padding: 0 0.5rem;
  }
  label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--color-primary);
  }
  .required-indicator {
    color: var(--color-error);
    margin-left: 0.25rem;
  }
  input[type="text"],
  select {
    font-size: 1rem;
    padding: 0.5rem 0.75rem;
    border: 2px solid var(--color-border);
    border-radius: 4px;
    width: 100%;
    max-width: 400px;
    box-sizing: border-box;
    color: var(--color-text);
  }
  input[type="text"]:focus,
  select:focus {
    border-color: var(--color-accent);
    outline: 3px solid var(--color-focus);
    outline-offset: 2px;
  }
  /* Checkbox group */
  .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem 2rem;
  }
  .checkbox-group label {
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .checkbox-group input[type="checkbox"] {
    width: 20px;
    height: 20px;
    min-width: 20px;
    min-height: 20px;
    cursor: pointer;
  }
  .checkbox-group input[type="checkbox"]:focus-visible {
    outline: 3px solid var(--color-focus);
    outline-offset: 2px;
  }

  /* Buttons */
  button[type="submit"],
  button[type="button"] {
    background-color: var(--color-secondary);
    color: var(--color-bg);
    border: none;
    padding: 0.75rem 1.5rem;
    font-size: 1.125rem;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    min-width: 120px;
    min-height: 44px;
    box-shadow: 0 3px 8px var(--color-shadow);
    transition: background-color 0.3s ease;
  }
  button[type="submit"]:hover,
  button[type="submit"]:focus-visible,
  button[type="button"]:hover,
  button[type="button"]:focus-visible {
    background-color: var(--color-primary);
    outline: none;
  }
  button[type="submit"]:focus-visible,
  button[type="button"]:focus-visible {
    outline: 3px solid var(--color-focus);
    outline-offset: 2px;
  }
  button[disabled] {
    background-color: #999999;
    cursor: not-allowed;
    box-shadow: none;
  }

  /* Error messages */
  .error-message {
    color: var(--color-error);
    font-weight: 700;
    margin-top: 0.25rem;
    font-size: 0.875rem;
  }

  /* Recommendations section */
  #recommendations {
    border: 3px solid var(--color-accent);
    border-radius: 8px;
    padding: 1.5rem 2rem;
    background-color: #e6ffe6;
    box-shadow: 0 4px 12px var(--color-shadow);
  }
  #recommendations h2 {
    margin-top: 0;
    color: var(--color-accent);
  }
  #recommendations p.status-message {
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: 1rem;
  }
  #recommendations ul.book-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 1.5rem;
  }
  #recommendations li.book-card {
    background-color: var(--color-bg);
    border: 2px solid var(--color-accent);
    border-radius: 8px;
    box-shadow: 0 2px 8px var(--color-shadow);
    display: flex;
    flex-direction: column;
    max-width: 100%;
  }
  #recommendations img.book-cover {
    width: 100%;
    height: auto;
    border-bottom: 2px solid var(--color-accent);
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
  }
  #recommendations div.book-info {
    padding: 1rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  #recommendations h3.book-title {
    margin: 0 0 0.25rem;
    color: var(--color-primary);
    font-size: 1.25rem;
  }
  #recommendations p.book-author {
    margin: 0 0 0.5rem;
    font-weight: 600;
    color: var(--color-secondary);
  }
  #recommendations p.book-description {
    flex-grow: 1;
    margin: 0;
    color: var(--color-text);
  }

  /* Responsive */
  @media (max-width: 480px) {
    nav[aria-label="Primary"] ul {
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
    }
  }

  /* Focus enhancements */
  :focus-visible {
    outline-offset: 2px;
    outline-width: 3px;
    outline-style: solid;
    outline-color: var(--color-focus);
  }

  /* User-selectable foreground/background color */
  #color-controls {
    margin: 1rem 0 2rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem 2rem;
    align-items: center;
  }
  #color-controls label {
    font-weight: 600;
    color: var(--color-primary);
  }
  #color-controls select {
    padding: 0.25rem 0.5rem;
    font-size: 1rem;
    border-radius: 4px;
    border: 2px solid var(--color-border);
    cursor: pointer;
  }
  #color-controls select:focus {
    border-color: var(--color-accent);
    outline: 3px solid var(--color-focus);
    outline-offset: 2px;
  }
</style>
</head>
<body>
<a href="#maincontent" class="skip-link">Skip to main content</a>

<header>
  <h1 id="page-title">Personalized Book Recommendations by Genre &amp; Author</h1>
  <p>Discover books tailored to your favorite genres and authors</p>
</header>

<nav aria-label="Primary">
  <ul>
    <li><a href="#form-section" id="nav-form" tabindex="0">Preferences Form</a></li>
    <li><a href="#recommendations" id="nav-recommendations" tabindex="0">Book Recommendations</a></li>
    <li class="dropdown">
      <button aria-haspopup="true" aria-expanded="false" id="more-menu-button" aria-controls="more-menu">More Options</button>
      <div class="dropdown-menu" id="more-menu" role="menu" aria-hidden="true">
        <ul>
          <li><a href="#color-controls" role="menuitem" tabindex="-1">Color Settings</a></li>
          <li><a href="#help-section" role="menuitem" tabindex="-1">Help &amp; Info</a></li>
        </ul>
      </div>
    </li>
  </ul>
</nav>

<nav aria-label="Breadcrumb" class="container" role="navigation">
  <ol>
    <li><a href="#page-title">Home</a></li>
    <li><a href="#form-section">Preferences</a></li>
    <li aria-current="page">Recommendations</li>
  </ol>
</nav>

<main id="maincontent" tabindex="-1" class="container" role="main" aria-labelledby="page-title">

  <section id="form-section" aria-labelledby="form-heading">
    <h2 id="form-heading">Tell Us Your Preferences</h2>
    <form id="preferences-form" novalidate aria-describedby="form-help" autocomplete="on" aria-live="polite" aria-relevant="additions removals">
      <p id="form-help" class="info-text" style="max-width: 600px; margin-bottom:1rem; color: var(--color-primary); font-weight:600;">
        Select your favorite genres and authors to receive personalized book recommendations. Required fields are marked with <span aria-hidden="true" class="required-indicator">*</span>.
      </p>

      <fieldset>
        <legend>Favorite Genres <span class="required-indicator" aria-hidden="true">*</span></legend>
        <div class="checkbox-group" role="group" aria-labelledby="genre-legend" id="genres-group">
          <label for="genre-fiction"><input type="checkbox" id="genre-fiction" name="genres" value="Fiction" aria-describedby="genre-help" /> Fiction</label>
          <label for="genre-nonfiction"><input type="checkbox" id="genre-nonfiction" name="genres" value="Nonfiction" aria-describedby="genre-help" /> Nonfiction</label>
          <label for="genre-mystery"><input type="checkbox" id="genre-mystery" name="genres" value="Mystery" aria-describedby="genre-help" /> Mystery</label>
          <label for="genre-fantasy"><input type="checkbox" id="genre-fantasy" name="genres" value="Fantasy" aria-describedby="genre-help" /> Fantasy</label>
          <label for="genre-scifi"><input type="checkbox" id="genre-scifi" name="genres" value="Science Fiction" aria-describedby="genre-help" /> Science Fiction</label>
          <label for="genre-biography"><input type="checkbox" id="genre-biography" name="genres" value="Biography" aria-describedby="genre-help" /> Biography</label>
          <label for="genre-romance"><input type="checkbox" id="genre-romance" name="genres" value="Romance" aria-describedby="genre-help" /> Romance</label>
          <label for="genre-history"><input type="checkbox" id="genre-history" name="genres" value="History" aria-describedby="genre-help" /> History</label>
        </div>
        <p id="genre-help" class="info-text" style="font-size: 0.875rem; margin-top: 0.25rem; color: var(--color-primary);">
          Choose at least one genre you enjoy reading.
        </p>
        <p id="genres-error" class="error-message" aria-live="assertive" role="alert" hidden></p>
      </fieldset>

      <fieldset>
        <legend for="author-input">Favorite Authors <span class="required-indicator" aria-hidden="true">*</span></legend>
        <label for="author-input">Enter one or more favorite authors, separated by commas</label>
        <input 
          type="text" 
          id="author-input" 
          name="authors" 
          aria-describedby="author-help" 
          aria-required="true" 
          required 
          autocomplete="off" 
          placeholder="e.g., Agatha Christie, J.K. Rowling" 
          minlength="3"
          maxlength="100"
          aria-invalid="false"
          />
        <p id="author-help" class="info-text" style="font-size: 0.875rem; margin-top: 0.25rem; color: var(--color-primary);">
          Please enter at least one author name, separated by commas if multiple.
        </p>
        <p id="authors-error" class="error-message" aria-live="assertive" role="alert" hidden></p>
      </fieldset>

      <button type="submit" aria-label="Submit preferences to get book recommendations" id="submit-button">Get Recommendations</button>
      <button type="button" id="reset-button" aria-label="Reset preferences form">Reset</button>
    </form>
  </section>

  <section id="recommendations" aria-labelledby="recommendations-heading" tabindex="-1">
    <h2 id="recommendations-heading">Book Recommendations</h2>
    <p id="recommendation-status" class="status-message" aria-live="polite" role="status">Please fill out the form above and submit to see personalized book recommendations.</p>
    <ul class="book-list" id="book-list" aria-live="polite" aria-relevant="additions" aria-atomic="true"></ul>
  </section>

  <section id="color-controls" aria-label="Color customization controls" class="container">
    <h2>Customize Foreground and Background Colors</h2>
    <form id="color-form" aria-describedby="color-help" novalidate>
      <p id="color-help" class="info-text" style="max-width: 600px; margin-bottom:1rem; color: var(--color-primary); font-weight:600;">
        Select text and background colors to improve readability. Changes will apply immediately.
      </p>
      <label for="foreground-select">Text Color:</label>
      <select id="foreground-select" name="foreground" aria-label="Select text color">
        <option value="#1a1a1a" selected>Dark Gray</option>
        <option value="#004d99">Dark Blue</option>
        <option value="#cc0000">Dark Red</option>
        <option value="#004d33">Dark Green</option>
        <option value="#000000">Black</option>
      </select>

      <label for="background-select" style="margin-left: 1rem;">Background Color:</label>
      <select id="background-select" name="background" aria-label="Select background color">
        <option value="#ffffff" selected>White</option>
        <option value="#f0f8ff">Alice Blue</option>
        <option value="#fffff0">Ivory</option>
        <option value="#e6ffe6">Light Green</option>
        <option value="#fff0f0">Light Pink</option>
      </select>
    </form>
  </section>

  <section id="help-section" aria-labelledby="help-heading" class="container" style="margin-top: 3rem;">
    <h2 id="help-heading">Help &amp; Information</h2>
    <article>
      <h3>How to Use the Book Recommendation Tool</h3>
      <p>This tool helps you discover books that match your favorite genres and authors. Simply select one or more genres and enter author names separated by commas, then submit the form. Recommendations will appear below with book covers and descriptions.</p>
    </article>
    <article>
      <h3>Accessibility Features</h3>
      <p>This webpage meets WCAG 2.2 AAA accessibility standards, including:</p>
      <ul>
        <li>Keyboard accessible navigation and forms</li>
        <li>Enhanced focus indicators and logical tab order</li>
        <li>High contrast color schemes with user-selectable foreground and background colors</li>
        <li>Descriptive labels, error messages, and ARIA live regions</li>
        <li>Skip links and semantic HTML5 landmarks</li>
      </ul>
    </article>
    <article>
      <h3>Definitions</h3>
      <dl>
        <dt>Genre</dt>
        <dd lang="en">A category of literary composition characterized by a particular style, form, or content.</dd>
        <dt>Author</dt>
        <dd lang="en">A person who writes books or other literary works.</dd>
      </dl>
    </article>
  </section>

</main>

<footer role="contentinfo" class="container" style="margin-top: 3rem; border-top: 4px solid var(--color-primary); padding-top: 1rem; color: var(--color-primary); font-weight: 600; text-align: center;">
  <p>© 2024 Accessible Book Recommendations. All rights reserved.</p>
  <p><a href="#page-title">Back to top</a></p>
</footer>

<script>
  (() => {
    'use strict';

    // Data: Sample book database with genre and author tags
    const books = [
      {
        title: "The Mystery of the Blue Train",
        author: "Agatha Christie",
        genres: ["Mystery", "Fiction"],
        description: "A classic detective novel featuring Hercule Poirot investigating a murder on a train.",
        cover: "https://upload.wikimedia.org/wikipedia/en/3/30/The_Mystery_of_the_Blue_Train_First_Edition_Cover_1928.jpg",
        alt: "Cover of The Mystery of the Blue Train book showing a train in motion"
      },
      {
        title: "Harry Potter and the Sorcerer's Stone",
        author: "J.K. Rowling",
        genres: ["Fantasy", "Fiction"],
        description: "The first book in the Harry Potter series introducing the young wizard's magical adventures.",
        cover: "https://upload.wikimedia.org/wikipedia/en/6/6b/Harry_Potter_and_the_Philosopher%27s_Stone_Book_Cover.jpg",
        alt: "Cover of Harry Potter and the Sorcerer's Stone book showing Harry Potter with a wand"
      },
      {
        title: "A Brief History of Time",
        author: "Stephen Hawking",
        genres: ["Nonfiction", "Science Fiction", "Biography"],
        description: "An accessible exploration of cosmology and the nature of the universe by renowned physicist Stephen Hawking.",
        cover: "https://upload.wikimedia.org/wikipedia/en/b/b8/BriefHistoryTime.jpg",
        alt: "Cover of A Brief History of Time book with a black background and yellow text"
      },
      {
        title: "Pride and Prejudice",
        author: "Jane Austen",
        genres: ["Romance", "Fiction", "History"],
        description: "A romantic novel that also critiques the British landed gentry at the end of the 18th century.",
        cover: "https://upload.wikimedia.org/wikipedia/commons/1/15/PrideAndPrejudiceTitlePage.jpg",
        alt: "Title page cover of Pride and Prejudice book"
      },
      {
        title: "The Hobbit",
        author: "J.R.R. Tolkien",
        genres: ["Fantasy", "Fiction"],
        description: "A fantasy novel about the journey of Bilbo Baggins, a hobbit who embarks on an epic quest.",
        cover: "https://upload.wikimedia.org/wikipedia/en/4/4a/TheHobbit_FirstEdition.jpg",
        alt: "Cover of The Hobbit book showing a dragon and a mountain"
      },
      {
        title: "The Immortal Life of Henrietta Lacks",
        author: "Rebecca Skloot",
        genres: ["Biography", "Nonfiction"],
        description: "The story of Henrietta Lacks and the immortal cell line, HeLa, that came from her cancer cells.",
        cover: "https://upload.wikimedia.org/wikipedia/en/0/0f/The_Immortal_Life_of_Henrietta_Lacks_cover.jpg",
        alt: "Cover of The Immortal Life of Henrietta Lacks book with a portrait of a woman"
      },
      {
        title: "Dune",
        author: "Frank Herbert",
        genres: ["Science Fiction", "Fiction"],
        description: "An epic science fiction novel about politics, religion, and ecology on the desert planet Arrakis.",
        cover: "https://upload.wikimedia.org/wikipedia/en/a/a9/Dune_First_edition.jpg",
        alt: "Cover of Dune book showing desert landscape and a giant sandworm"
      },
      {
        title: "The Diary of a Young Girl",
        author: "Anne Frank",
        genres: ["Biography", "History", "Nonfiction"],
        description: "The wartime diary of Anne Frank, a Jewish girl hiding during World War II.",
        cover: "https://upload.wikimedia.org/wikipedia/en/e/e7/Anne_Frank_the_Diary_of_a_Young_Girl.jpg",
        alt: "Cover of The Diary of a Young Girl book with a photo of Anne Frank"
      },
      {
        title: "Gone with the Wind",
        author: "Margaret Mitchell",
        genres: ["Romance", "History", "Fiction"],
        description: "A historical romance novel set during the American Civil War and Reconstruction era.",
        cover: "https://upload.wikimedia.org/wikipedia/en/4/4b/Gone_with_the_Wind_cover.jpg",
        alt: "Cover of Gone with the Wind book showing Scarlett O'Hara"
      }
    ];

    // DOM Elements
    const form = document.getElementById('preferences-form');
    const genresGroup = document.getElementById('genres-group');
    const authorInput = document.getElementById('author-input');
    const genresError = document.getElementById('genres-error');
    const authorsError = document.getElementById('authors-error');
    const submitButton = document.getElementById('submit-button');
    const resetButton = document.getElementById('reset-button');
    const bookList = document.getElementById('book-list');
    const recommendationStatus = document.getElementById('recommendation-status');
    const mainContent = document.getElementById('maincontent');

    // Dropdown menu elements
    const moreMenuButton = document.getElementById('more-menu-button');
    const moreMenu = document.getElementById('more-menu');

    // Color customization controls
    const fgSelect = document.getElementById('foreground-select');
    const bgSelect = document.getElementById('background-select');

    // Utility: Check contrast ratio (WCAG 2.2 AAA requires 7:1 for normal text)
    // Using simplified luminance formula and contrast calculation
    function luminance(r, g, b) {
      const a = [r, g, b].map(v => {
        v /= 255;
        return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
      });
      return 0.2126 * a[0] + 0.7152 * a[1] + 0.0722 * a[2];
    }
    function contrastRatio(rgb1, rgb2) {
      const lum1 = luminance(...rgb1);
      const lum2 = luminance(...rgb2);
      return (Math.max(lum1, lum2) + 0.05) / (Math.min(lum1, lum2) + 0.05);
    }
    function hexToRgb(hex) {
      const parsed = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return parsed ? [
        parseInt(parsed[1], 16),
        parseInt(parsed[2], 16),
        parseInt(parsed[3], 16)
      ] : null;
    }

    // Validate form inputs
    function validateForm() {
      let valid = true;

      // Validate genres: at least one checkbox checked
      const checkedGenres = [...genresGroup.querySelectorAll('input[type="checkbox"]:checked')];
      if (checkedGenres.length === 0) {
        genresError.textContent = "Please select at least one genre.";
        genresError.hidden = false;
        genresGroup.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.setAttribute('aria-invalid', 'true');
        });
        valid = false;
      } else {
        genresError.textContent = "";
        genresError.hidden = true;
        genresGroup.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.removeAttribute('aria-invalid');
        });
      }

      // Validate authors: must have at least one non-empty author name
      const authorsRaw = authorInput.value.trim();
      if (!authorsRaw) {
        authorsError.textContent = "Please enter at least one author name.";
        authorsError.hidden = false;
        authorInput.setAttribute('aria-invalid', 'true');
        valid = false;
      } else {
        // Validate author names: split by commas, each name min 2 chars
        const authors = authorsRaw.split(',').map(a => a.trim()).filter(a => a.length > 0);
        if (authors.length === 0) {
          authorsError.textContent = "Please enter at least one valid author name.";
          authorsError.hidden = false;
          authorInput.setAttribute('aria-invalid', 'true');
          valid = false;
        } else if (authors.some(a => a.length < 2)) {
          authorsError.textContent = "Each author name must be at least 2 characters.";
          authorsError.hidden = false;
          authorInput.setAttribute('aria-invalid', 'true');
          valid = false;
        } else {
          authorsError.textContent = "";
          authorsError.hidden = true;
          authorInput.removeAttribute('aria-invalid');
        }
      }

      return valid;
    }

    // Clear recommendations display
    function clearRecommendations() {
      bookList.innerHTML = "";
      recommendationStatus.textContent = "Please fill out the form above and submit to see personalized book recommendations.";
    }

    // Generate recommendations based on user input
    function generateRecommendations(genres, authors) {
      // Normalize input for matching (case-insensitive)
      const genresSet = new Set(genres.map(g => g.toLowerCase()));
      const authorsSet = new Set(authors.map(a => a.toLowerCase()));

      // Filter books matching any genre AND any author (partial author match allowed)
      const matchedBooks = books.filter(book => {
        // Check genre intersection
        const bookGenresLower = book.genres.map(g => g.toLowerCase());
        const genreMatch = bookGenresLower.some(g => genresSet.has(g));
        if (!genreMatch) return false;

        // Check author match (partial match: any input author substring in book author)
        const bookAuthorLower = book.author.toLowerCase();
        const authorMatch = [...authorsSet].some(inputAuthor => bookAuthorLower.includes(inputAuthor));
        return authorMatch;
      });

      return matchedBooks;
    }

    // Render recommendations
    function renderRecommendations(bookArray) {
      bookList.innerHTML = "";
      if (bookArray.length === 0) {
        recommendationStatus.textContent = "No books found matching your preferences. Please try different genres or authors.";
        return;
      }
      recommendationStatus.textContent = `Found ${bookArray.length} book${bookArray.length > 1 ? 's' : ''} matching your preferences:`;

      const fragment = document.createDocumentFragment();
      bookArray.forEach(book => {
        const li = document.createElement('li');
        li.className = "book-card";

        const img = document.createElement('img');
        img.src = book.cover;
        img.alt = book.alt;
        img.className = "book-cover";
        img.loading = "lazy";
        img.width = 280;
        img.height = 420;
        li.appendChild(img);

        const infoDiv = document.createElement('div');
        infoDiv.className = "book-info";

        const title = document.createElement('h3');
        title.className = "book-title";
        title.textContent = book.title;
        infoDiv.appendChild(title);

        const author = document.createElement('p');
        author.className = "book-author";
        author.textContent = `by ${book.author}`;
        infoDiv.appendChild(author);

        const desc = document.createElement('p');
        desc.className = "book-description";
        desc.textContent = book.description;
        infoDiv.appendChild(desc);

        li.appendChild(infoDiv);
        fragment.appendChild(li);
      });
      bookList.appendChild(fragment);
      bookList.querySelector('li')?.focus();
    }

    // Handle form submission
    form.addEventListener('submit', e => {
      e.preventDefault();
      if (!validateForm()) {
        recommendationStatus.textContent = "Please fix the errors in the form to get recommendations.";
        return;
      }
      // Get selected genres
      const selectedGenres = [...genresGroup.querySelectorAll('input[type="checkbox"]:checked')].map(cb => cb.value);
      // Get authors list
      const authorsRaw = authorInput.value.trim();
      const authorsList = authorsRaw.split(',').map(a => a.trim()).filter(a => a.length > 0);

      // Generate recommendations
      const recommendations = generateRecommendations(selectedGenres, authorsList);
      renderRecommendations(recommendations);

      // Move focus to recommendations section for screen reader users
      recommendationStatus.focus();
    });

    // Reset form handler
    resetButton.addEventListener('click', () => {
      form.reset();
      genresError.textContent = "";
      genresError.hidden = true;
      authorsError.textContent = "";
      authorsError.hidden = true;
      authorInput.removeAttribute('aria-invalid');
      genresGroup.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.removeAttribute('aria-invalid'));
      clearRecommendations();
      submitButton.focus();
    });

    // Keyboard accessible dropdown menu for "More Options"
    moreMenuButton.addEventListener('click', () => {
      const expanded = moreMenuButton.getAttribute('aria-expanded') === 'true';
      moreMenuButton.setAttribute('aria-expanded', String(!expanded));
      moreMenu.setAttribute('aria-hidden', String(expanded));
      if (!expanded) {
        // Focus first menu item
        const firstMenuItem = moreMenu.querySelector('a');
        firstMenuItem?.focus();
      } else {
        moreMenuButton.focus();
      }
    });

    // Close dropdown on Escape or click outside
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && moreMenuButton.getAttribute('aria-expanded') === 'true') {
        moreMenuButton.setAttribute('aria-expanded', 'false');
        moreMenu.setAttribute('aria-hidden', 'true');
        moreMenuButton.focus();
      }
    });
    document.addEventListener('click', e => {
      if (!moreMenu.contains(e.target) && e.target !== moreMenuButton) {
        moreMenuButton.setAttribute('aria-expanded', 'false');
        moreMenu.setAttribute('aria-hidden', 'true');
      }
    });

    // Keyboard navigation for dropdown menu (Arrow keys)
    moreMenu.addEventListener('keydown', e => {
      const focusableItems = [...moreMenu.querySelectorAll('a[role="menuitem"]')];
      let index = focusableItems.indexOf(document.activeElement);
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        index = (index + 1) % focusableItems.length;
        focusableItems[index].focus();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        index = (index - 1 + focusableItems.length) % focusableItems.length;
        focusableItems[index].focus();
      } else if (e.key === 'Tab') {
        // Close menu on tab out
        moreMenuButton.setAttribute('aria-expanded', 'false');
        moreMenu.setAttribute('aria-hidden', 'true');
      }
    });

    // Color customization: apply user-selected colors with contrast check
    function applyColors(fgHex, bgHex) {
      const fgRgb = hexToRgb(fgHex);
      const bgRgb = hexToRgb(bgHex);
      if (!fgRgb || !bgRgb) return;

      // Check contrast ratio
      const ratio = contrastRatio(fgRgb, bgRgb);
      // Minimum 7:1 for normal text (AAA)
      if (ratio < 7) {
        // Warn user but still apply colors
        alert("Warning: The selected text and background colors have insufficient contrast for AAA compliance. Please choose different colors.");
      }
      document.body.style.color = fgHex;
      document.body.style.backgroundColor = bgHex;

      // Also update border colors of containers for sufficient contrast
      // For simplicity, adjust border color if contrast low
      const borderElements = document.querySelectorAll('fieldset, form, #recommendations');
      borderElements.forEach(el => {
        el.style.borderColor = fgHex;
      });
    }

    fgSelect.addEventListener('change', () => {
      applyColors(fgSelect.value, bgSelect.value);
    });
    bgSelect.addEventListener('change', () => {
      applyColors(fgSelect.value, bgSelect.value);
    });

    // Initialize colors on load
    window.addEventListener('load', () => {
      applyColors(fgSelect.value, bgSelect.value);
      clearRecommendations();
    });

  })();
</script>
</body>
</html>