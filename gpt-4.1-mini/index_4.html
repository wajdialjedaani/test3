<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2" />
<title>Local Events Showcase - Discover & Filter Community Activities</title>
<style>
  /* Reset and base */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  html {
    font-size: 100%;
    scroll-behavior: smooth;
  }
  body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    background: linear-gradient(135deg, #f0f8ff, #e6f0ff);
    color: #0a1f44;
    min-width: 320px;
    max-width: 100vw;
  }
  a {
    color: #004080;
    text-decoration: underline;
  }
  a:focus, button:focus, input:focus, select:focus, textarea:focus {
    outline: 3px solid #ffbf47;
    outline-offset: 2px;
  }
  h1, h2, h3 {
    margin-top: 0;
    font-weight: 700;
    color: #002050;
  }
  h1 {
    font-size: 2.25rem;
    line-height: 1.2;
  }
  h2 {
    font-size: 1.75rem;
    margin-bottom: 0.5em;
  }
  h3 {
    font-size: 1.25rem;
  }
  p {
    max-width: 80ch;
    margin-top: 0;
    margin-bottom: 1.5em;
  }
  strong {
    font-weight: 700;
  }
  em {
    font-style: italic;
  }
  ul, ol {
    margin-top: 0;
    margin-bottom: 1.5em;
    padding-left: 2.25rem;
  }
  li {
    margin-bottom: 0.5em;
  }

  /* Skip link */
  .skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: #004080;
    color: #fff;
    padding: 0.75rem 1rem;
    z-index: 100;
    border-radius: 0 0 4px 0;
    font-weight: 700;
    text-decoration: none;
  }
  .skip-link:focus {
    top: 0;
  }

  /* Layout grid */
  .page-wrapper {
    display: grid;
    grid-template-columns: 1fr minmax(auto, 1200px) 1fr;
  }
  main {
    grid-column: 2;
    padding: 1rem 1.5rem 3rem;
  }

  /* Header */
  header {
    background: linear-gradient(90deg, #004080, #0070cc);
    color: #ffffff;
    padding: 1rem 1.5rem;
    grid-column: 1 / -1;
    box-shadow: 0 4px 8px rgb(0 0 0 / 0.15);
  }
  header h1 {
    margin: 0;
  }

  /* Navigation */
  nav[aria-label="Primary"] {
    background-color: #003366;
    color: #e0e7ff;
    padding: 0.75rem 1.5rem;
    box-shadow: inset 0 -3px 0 #ffbf47;
  }
  nav[aria-label="Primary"] ul {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    gap: 1rem;
  }
  nav[aria-label="Primary"] li {
    position: relative;
  }
  nav[aria-label="Primary"] a, nav[aria-label="Primary"] button {
    color: #e0e7ff;
    background: none;
    border: none;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    text-decoration: none;
  }
  nav[aria-label="Primary"] a:hover,
  nav[aria-label="Primary"] a:focus,
  nav[aria-label="Primary"] button:hover,
  nav[aria-label="Primary"] button:focus {
    background-color: #0059b3;
    outline-offset: 2px;
  }
  nav[aria-label="Primary"] button[aria-expanded="true"] {
    background-color: #004080;
  }
  /* Dropdown menu */
  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background-color: #004080;
    border: 2px solid #ffbf47;
    border-radius: 4px;
    padding: 0.5rem 0;
    min-width: 180px;
    box-shadow: 0 4px 8px rgb(0 0 0 / 0.3);
    z-index: 1000;
    display: none;
  }
  .dropdown-menu[aria-hidden="false"] {
    display: block;
  }
  .dropdown-menu a {
    display: block;
    padding: 0.5rem 1rem;
    color: #e0e7ff;
    text-decoration: none;
  }
  .dropdown-menu a:hover,
  .dropdown-menu a:focus {
    background-color: #0059b3;
    outline-offset: 2px;
  }

  /* Breadcrumbs */
  nav[aria-label="Breadcrumb"] {
    margin: 1rem 0;
  }
  nav[aria-label="Breadcrumb"] ol {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    gap: 0.5rem;
    font-size: 0.875rem;
  }
  nav[aria-label="Breadcrumb"] li::after {
    content: "‚Ä∫";
    margin-left: 0.5rem;
    color: #666;
  }
  nav[aria-label="Breadcrumb"] li:last-child::after {
    content: "";
  }
  nav[aria-label="Breadcrumb"] a {
    color: #004080;
    text-decoration: underline;
  }
  nav[aria-label="Breadcrumb"] a:focus {
    outline-offset: 2px;
  }

  /* Main content grid */
  .content-grid {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 2rem;
  }

  /* Sidebar */
  aside[aria-label="Event Filters"] {
    background: #e6f0ff;
    border: 3px solid #004080;
    border-radius: 8px;
    padding: 1rem 1.25rem;
    font-size: 1rem;
  }
  aside h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: #002050;
  }
  fieldset {
    border: none;
    margin: 0 0 1.5rem 0;
    padding: 0;
  }
  legend {
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: #002050;
  }
  .filter-option {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  .filter-option input[type="checkbox"] {
    width: 24px;
    height: 24px;
    margin-right: 0.5rem;
    cursor: pointer;
  }
  .filter-option label {
    cursor: pointer;
  }
  .filter-help {
    font-size: 0.875rem;
    color: #003366;
    margin-top: -0.5rem;
    margin-bottom: 1rem;
  }
  button#resetFilters {
    background-color: #ffbf47;
    border: none;
    padding: 0.5rem 1rem;
    font-weight: 700;
    color: #002050;
    border-radius: 6px;
    cursor: pointer;
    min-width: 120px;
    box-shadow: 0 2px 4px rgb(0 0 0 / 0.2);
    transition: background-color 0.3s ease;
  }
  button#resetFilters:hover,
  button#resetFilters:focus {
    background-color: #e6a400;
    outline-offset: 2px;
  }

  /* Event list */
  section#eventsSection {
    background: #ffffff;
    border: 3px solid #004080;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    color: #002050;
  }
  section#eventsSection h2 {
    margin-top: 0;
  }
  .events-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 1.5rem;
  }
  article.event-card {
    border: 2px solid #0070cc;
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    background: #f0f8ff;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
  }
  article.event-card:focus-within {
    outline: 3px solid #ffbf47;
    outline-offset: 3px;
  }
  .event-header {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
  }
  .event-image {
    flex: 0 0 160px;
    height: 120px;
    border-radius: 6px;
    object-fit: cover;
    border: 2px solid #004080;
  }
  .event-info {
    flex: 1 1 auto;
  }
  .event-title {
    font-size: 1.25rem;
    margin: 0 0 0.25rem 0;
    color: #003366;
  }
  .event-meta {
    font-size: 0.9rem;
    color: #004080;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }
  .event-meta time,
  .event-meta span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  .icon-calendar::before {
    content: "üìÖ";
    font-size: 1.1rem;
  }
  .icon-location::before {
    content: "üìç";
    font-size: 1.1rem;
  }
  .event-description {
    font-size: 1rem;
    line-height: 1.5;
  }
  .event-actions {
    margin-top: 1rem;
  }
  .btn-map-focus {
    background-color: #0070cc;
    color: #ffffff;
    border: none;
    padding: 0.5rem 1rem;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    min-width: 140px;
    box-shadow: 0 2px 4px rgb(0 0 0 / 0.2);
    transition: background-color 0.3s ease;
  }
  .btn-map-focus:hover,
  .btn-map-focus:focus {
    background-color: #004080;
    outline-offset: 2px;
  }

  /* Map container */
  #mapContainer {
    margin-top: 2rem;
    border: 3px solid #004080;
    border-radius: 8px;
    height: 400px;
    position: relative;
    background-color: #cce0ff;
    box-shadow: 0 4px 10px rgb(0 0 0 / 0.15);
  }
  #mapCanvas {
    width: 100%;
    height: 100%;
    border-radius: 8px;
  }
  #mapStatus {
    position: absolute;
    top: 0;
    left: 0;
    background: rgba(0 64 128 / 0.85);
    color: #ffbf47;
    font-weight: 700;
    padding: 0.5rem 1rem;
    border-radius: 0 0 8px 0;
    z-index: 10;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .content-grid {
      grid-template-columns: 1fr;
    }
    aside[aria-label="Event Filters"] {
      margin-bottom: 2rem;
    }
  }

  /* Focus ring enhancement */
  :focus-visible {
    outline-offset: 3px;
    outline: 3px solid #ffbf47;
  }

  /* Vibrant color-coded categories for event cards */
  .category-music {
    border-left: 8px solid #e63946;
  }
  .category-sports {
    border-left: 8px solid #2a9d8f;
  }
  .category-arts {
    border-left: 8px solid #f4a261;
  }
  .category-food {
    border-left: 8px solid #e9c46a;
  }
  .category-family {
    border-left: 8px solid #264653;
  }

  /* Visually hidden for accessibility */
  .visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    border: 0 !important;
  }

  /* User selectable foreground/background color controls */
  #colorControls {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    border: 3px solid #004080;
    border-radius: 8px;
    background: #e6f0ff;
    color: #002050;
    max-width: 600px;
  }
  #colorControls label {
    font-weight: 700;
    margin-right: 0.5rem;
  }
  #colorControls select {
    font-size: 1rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    border: 2px solid #004080;
    min-width: 150px;
    margin-right: 1rem;
  }
  #colorControls select:focus {
    outline-offset: 2px;
  }
</style>
</head>
<body>
<a href="#mainContent" class="skip-link" tabindex="0">Skip to main content</a>

<div class="page-wrapper">
  <header role="banner">
    <h1>Local Events Showcase</h1>
  </header>

  <nav aria-label="Primary" role="navigation">
    <ul>
      <li><a href="#eventsSection" tabindex="0">Events</a></li>
      <li>
        <button aria-haspopup="true" aria-expanded="false" aria-controls="categoriesMenu" id="categoriesMenuButton">
          Categories
        </button>
        <ul class="dropdown-menu" id="categoriesMenu" role="menu" aria-hidden="true" aria-label="Event Categories">
          <li role="none"><a href="#" role="menuitem" data-category="music" tabindex="-1">Music</a></li>
          <li role="none"><a href="#" role="menuitem" data-category="sports" tabindex="-1">Sports</a></li>
          <li role="none"><a href="#" role="menuitem" data-category="arts" tabindex="-1">Arts & Culture</a></li>
          <li role="none"><a href="#" role="menuitem" data-category="food" tabindex="-1">Food & Drink</a></li>
          <li role="none"><a href="#" role="menuitem" data-category="family" tabindex="-1">Family</a></li>
          <li role="none"><a href="#" role="menuitem" data-category="all" tabindex="-1">All Categories</a></li>
        </ul>
      </li>
      <li><a href="#mapContainer" tabindex="0">Map</a></li>
      <li><a href="#colorControls" tabindex="0">Appearance Settings</a></li>
    </ul>
  </nav>

  <nav aria-label="Breadcrumb" role="navigation" aria-live="polite" aria-atomic="true">
    <ol>
      <li><a href="#mainContent">Home</a></li>
      <li>Events</li>
    </ol>
  </nav>

  <main id="mainContent" tabindex="-1">
    <div class="content-grid">

      <aside aria-label="Event Filters" role="region" aria-live="polite" aria-atomic="true">
        <h2 id="filterHeading">Filter Events by Category</h2>
        <form id="filterForm" aria-describedby="filterHelp" novalidate>
          <fieldset>
            <legend>Event Categories</legend>
            <p id="filterHelp" class="filter-help">
              Select one or more categories to filter events. Use <kbd>Space</kbd> or <kbd>Enter</kbd> to toggle checkboxes.
            </p>
            <div class="filter-option">
              <input type="checkbox" id="filterMusic" name="category" value="music" aria-describedby="filterMusicDesc" />
              <label for="filterMusic">Music <span aria-hidden="true" style="color:#e63946;">&#x266B;</span></label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filterSports" name="category" value="sports" aria-describedby="filterSportsDesc" />
              <label for="filterSports">Sports <span aria-hidden="true" style="color:#2a9d8f;">&#x26BD;</span></label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filterArts" name="category" value="arts" aria-describedby="filterArtsDesc" />
              <label for="filterArts">Arts &amp; Culture <span aria-hidden="true" style="color:#f4a261;">&#x270D;</span></label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filterFood" name="category" value="food" aria-describedby="filterFoodDesc" />
              <label for="filterFood">Food &amp; Drink <span aria-hidden="true" style="color:#e9c46a;">&#x1F374;</span></label>
            </div>
            <div class="filter-option">
              <input type="checkbox" id="filterFamily" name="category" value="family" aria-describedby="filterFamilyDesc" />
              <label for="filterFamily">Family <span aria-hidden="true" style="color:#264653;">&#x1F46A;</span></label>
            </div>
          </fieldset>
          <button type="button" id="resetFilters" aria-label="Reset all filters to show all events">Reset Filters</button>
        </form>
      </aside>

      <section id="eventsSection" aria-labelledby="eventsHeading" role="region">
        <h2 id="eventsHeading">Upcoming Local Events</h2>
        <ul class="events-list" id="eventsList" aria-live="polite" aria-relevant="additions removals" aria-atomic="false">
          <!-- Event cards inserted here dynamically -->
        </ul>
        <div id="noEventsMessage" role="alert" style="display:none; color:#b00020; font-weight:700; margin-top:1rem;">
          No events match the selected filters.
        </div>
      </section>
    </div>

    <section id="mapContainer" aria-label="Map showing event venue locations" role="region" tabindex="0">
      <div id="mapStatus" aria-live="polite" aria-atomic="true">Loading map...</div>
      <canvas id="mapCanvas" width="800" height="400" aria-describedby="mapDesc"></canvas>
      <p id="mapDesc" class="visually-hidden">
        This map displays markers for event venues in the local area. Users can navigate events by clicking on event cards or selecting filters. The map updates to show only venues for filtered events.
      </p>
    </section>

    <section id="colorControls" aria-label="Appearance Settings" role="region">
      <h2>Customize Appearance</h2>
      <form id="appearanceForm" aria-describedby="appearanceHelp" novalidate>
        <p id="appearanceHelp" class="filter-help">
          Choose foreground and background colors to improve readability and comfort. Changes apply immediately.
        </p>
        <label for="foregroundSelect">Text Color:</label>
        <select id="foregroundSelect" name="foreground" aria-required="true" required autocomplete="off">
          <option value="#0a1f44" selected>Dark Blue</option>
          <option value="#003366">Deep Navy</option>
          <option value="#264653">Slate Blue</option>
          <option value="#1b1b1b">Almost Black</option>
          <option value="#004d40">Teal</option>
        </select>

        <label for="backgroundSelect">Background Color:</label>
        <select id="backgroundSelect" name="background" aria-required="true" required autocomplete="off">
          <option value="#f0f8ff" selected>Light Blue</option>
          <option value="#ffffff">White</option>
          <option value="#e6f0ff">Soft Blue</option>
          <option value="#fef6e4">Warm Cream</option>
          <option value="#f0fff4">Pale Mint</option>
        </select>
      </form>
    </section>
  </main>

  <footer role="contentinfo" style="grid-column: 1 / -1; background-color: #003366; color: #e0e7ff; padding: 1rem 1.5rem; font-size: 0.875rem; text-align: center;">
    <p>¬© 2024 Local Events Showcase. All rights reserved.</p>
    <p>
      <a href="#mainContent" style="color:#ffbf47; text-decoration: underline;">Back to top</a>
    </p>
  </footer>
</div>

<script>
  'use strict';

  // Data: Example events
  const eventsData = [
    {
      id: "evt1",
      title: "Summer Jazz Festival",
      description: "Enjoy smooth jazz performances from local and international artists at the downtown park.",
      date: "2024-07-15T18:00:00",
      location: "Downtown Park Amphitheater",
      coordinates: { lat: 40.712776, lng: -74.005974 },
      category: "music",
      image: {
        src: "https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=400&q=80",
        alt: "Jazz band performing on stage with saxophone and trumpet"
      }
    },
    {
      id: "evt2",
      title: "City Marathon",
      description: "Annual city marathon with routes for all ages and abilities. Cheer on the runners!",
      date: "2024-08-10T07:30:00",
      location: "City Central Avenue",
      coordinates: { lat: 40.715, lng: -74.002 },
      category: "sports",
      image: {
        src: "https://images.unsplash.com/photo-1508609349937-5ec4ae374ebf?auto=format&fit=crop&w=400&q=80",
        alt: "Runners crossing the marathon finish line"
      }
    },
    {
      id: "evt3",
      title: "Artisan Craft Fair",
      description: "Discover handmade crafts, artworks, and unique gifts by local artisans at the community center.",
      date: "2024-07-20T10:00:00",
      location: "Community Center Hall",
      coordinates: { lat: 40.709, lng: -74.01 },
      category: "arts",
      image: {
        src: "https://images.unsplash.com/photo-1517694712202-14dd9538aa97?auto=format&fit=crop&w=400&q=80",
        alt: "Handmade pottery and crafts displayed on tables"
      }
    },
    {
      id: "evt4",
      title: "Food Truck Fiesta",
      description: "Taste delicious street food from a variety of food trucks gathered at the waterfront plaza.",
      date: "2024-07-25T12:00:00",
      location: "Waterfront Plaza",
      coordinates: { lat: 40.718, lng: -74.008 },
      category: "food",
      image: {
        src: "https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=400&q=80",
        alt: "Colorful food trucks lined up with people enjoying meals"
      }
    },
    {
      id: "evt5",
      title: "Family Fun Day",
      description: "A day full of games, workshops, and entertainment for families and children of all ages.",
      date: "2024-08-05T09:00:00",
      location: "City Park Playground",
      coordinates: { lat: 40.713, lng: -74.012 },
      category: "family",
      image: {
        src: "https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?auto=format&fit=crop&w=400&q=80",
        alt: "Children playing on playground equipment on a sunny day"
      }
    }
  ];

  // Elements
  const eventsListEl = document.getElementById('eventsList');
  const filterForm = document.getElementById('filterForm');
  const resetFiltersBtn = document.getElementById('resetFilters');
  const noEventsMessage = document.getElementById('noEventsMessage');
  const categoriesMenuBtn = document.getElementById('categoriesMenuButton');
  const categoriesMenu = document.getElementById('categoriesMenu');
  const mapCanvas = document.getElementById('mapCanvas');
  const mapStatus = document.getElementById('mapStatus');
  const foregroundSelect = document.getElementById('foregroundSelect');
  const backgroundSelect = document.getElementById('backgroundSelect');
  const appearanceForm = document.getElementById('appearanceForm');

  // Canvas 2D context
  const ctx = mapCanvas.getContext('2d');

  // Map boundaries and scaling (simple projection)
  // For demonstration, we use a fixed bounding box around events
  const latitudes = eventsData.map(e => e.coordinates.lat);
  const longitudes = eventsData.map(e => e.coordinates.lng);
  const latMin = Math.min(...latitudes) - 0.005;
  const latMax = Math.max(...latitudes) + 0.005;
  const lngMin = Math.min(...longitudes) - 0.005;
  const lngMax = Math.max(...longitudes) + 0.005;

  // Map padding
  const padding = 40;

  // Map marker radius
  const markerRadius = 10;

  // State
  let filteredCategories = new Set();
  let focusedEventId = null;

  // Accessibility live region for map updates
  const mapLiveRegion = mapStatus;

  // Utility: format date/time for display
  function formatEventDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString(undefined, {
      weekday: "short",
      year: "numeric",
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      hour12: true,
    });
  }

  // Utility: clear children of an element
  function clearChildren(el) {
    while (el.firstChild) {
      el.removeChild(el.firstChild);
    }
  }

  // Render event cards based on filtered categories
  function renderEvents() {
    clearChildren(eventsListEl);
    const filteredEvents = eventsData.filter(event => {
      if (filteredCategories.size === 0) return true;
      return filteredCategories.has(event.category);
    });

    if (filteredEvents.length === 0) {
      noEventsMessage.style.display = "block";
    } else {
      noEventsMessage.style.display = "none";
    }

    filteredEvents.forEach(event => {
      const article = document.createElement('article');
      article.className = `event-card category-${event.category}`;
      article.setAttribute('tabindex', '-1');
      article.setAttribute('aria-labelledby', `${event.id}-title`);
      article.setAttribute('role', 'article');

      // Event header with image and title/meta
      const headerDiv = document.createElement('div');
      headerDiv.className = 'event-header';

      const img = document.createElement('img');
      img.className = 'event-image';
      img.src = event.image.src;
      img.alt = event.image.alt;
      img.width = 160;
      img.height = 120;
      img.loading = "lazy";
      img.decoding = "async";
      img.setAttribute('aria-describedby', `${event.id}-desc`);

      const infoDiv = document.createElement('div');
      infoDiv.className = 'event-info';

      const title = document.createElement('h3');
      title.className = 'event-title';
      title.id = `${event.id}-title`;
      title.textContent = event.title;

      const metaDiv = document.createElement('div');
      metaDiv.className = 'event-meta';

      const dateSpan = document.createElement('time');
      dateSpan.dateTime = event.date;
      dateSpan.className = 'icon-calendar';
      dateSpan.textContent = formatEventDate(event.date);

      const locationSpan = document.createElement('span');
      locationSpan.className = 'icon-location';
      locationSpan.textContent = event.location;

      metaDiv.appendChild(dateSpan);
      metaDiv.appendChild(locationSpan);

      infoDiv.appendChild(title);
      infoDiv.appendChild(metaDiv);

      headerDiv.appendChild(img);
      headerDiv.appendChild(infoDiv);

      const descP = document.createElement('p');
      descP.className = 'event-description';
      descP.id = `${event.id}-desc`;
      descP.textContent = event.description;

      // Action buttons
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'event-actions';

      const btnMapFocus = document.createElement('button');
      btnMapFocus.type = 'button';
      btnMapFocus.className = 'btn-map-focus';
      btnMapFocus.textContent = `Show "${event.title}" on map`;
      btnMapFocus.setAttribute('aria-describedby', `${event.id}-desc`);
      btnMapFocus.dataset.eventId = event.id;
      btnMapFocus.addEventListener('click', () => {
        focusMapOnEvent(event.id);
        btnMapFocus.focus();
      });

      actionsDiv.appendChild(btnMapFocus);

      article.appendChild(headerDiv);
      article.appendChild(descP);
      article.appendChild(actionsDiv);

      eventsListEl.appendChild(article);
    });
  }

  // Map projection: lat/lng to canvas coordinates
  function project(lat, lng) {
    // Linear projection within bounding box and padding
    const x = padding + ((lng - lngMin) / (lngMax - lngMin)) * (mapCanvas.width - 2 * padding);
    const y = mapCanvas.height - (padding + ((lat - latMin) / (latMax - latMin)) * (mapCanvas.height - 2 * padding));
    return { x, y };
  }

  // Draw map background and markers
  function drawMap() {
    // Clear canvas
    ctx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);

    // Draw background gradient
    const grad = ctx.createLinearGradient(0, 0, 0, mapCanvas.height);
    grad.addColorStop(0, '#cce0ff');
    grad.addColorStop(1, '#ffffff');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);

    // Draw grid lines for latitude and longitude
    ctx.strokeStyle = '#004080';
    ctx.lineWidth = 1;
    ctx.font = '12px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
    ctx.fillStyle = '#004080';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';

    // Latitude lines (5 lines)
    for (let i = 0; i <= 4; i++) {
      const latVal = latMin + i * (latMax - latMin) / 4;
      const y = project(latVal, lngMin).y;
      ctx.beginPath();
      ctx.moveTo(padding, y);
      ctx.lineTo(mapCanvas.width - padding, y);
      ctx.stroke();
      ctx.fillText(latVal.toFixed(4), padding / 2, y - 6);
    }

    // Longitude lines (5 lines)
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    for (let i = 0; i <= 4; i++) {
      const lngVal = lngMin + i * (lngMax - lngMin) / 4;
      const x = project(latMin, lngVal).x;
      ctx.beginPath();
      ctx.moveTo(x, padding);
      ctx.lineTo(x, mapCanvas.height - padding);
      ctx.stroke();
      ctx.fillText(lngVal.toFixed(4), x, mapCanvas.height - padding / 2);
    }

    // Draw markers for filtered events
    const filteredEvents = eventsData.filter(event => {
      if (filteredCategories.size === 0) return true;
      return filteredCategories.has(event.category);
    });

    filteredEvents.forEach(event => {
      const { x, y } = project(event.coordinates.lat, event.coordinates.lng);
      ctx.beginPath();
      ctx.fillStyle = getCategoryColor(event.category);
      ctx.strokeStyle = '#002050';
      ctx.lineWidth = 2;
      ctx.shadowColor = 'rgba(0,0,0,0.3)';
      ctx.shadowBlur = 4;
      ctx.arc(x, y, markerRadius, 0, 2 * Math.PI);
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.stroke();

      // If focused event, draw a highlight ring
      if (event.id === focusedEventId) {
        ctx.beginPath();
        ctx.strokeStyle = '#ffbf47';
        ctx.lineWidth = 4;
        ctx.setLineDash([8, 6]);
        ctx.arc(x, y, markerRadius + 6, 0, 2 * Math.PI);
        ctx.stroke();
        ctx.setLineDash([]);
      }
    });
  }

  // Get category color for markers and borders
  function getCategoryColor(category) {
    switch (category) {
      case 'music': return '#e63946'; // red
      case 'sports': return '#2a9d8f'; // teal
      case 'arts': return '#f4a261'; // orange
      case 'food': return '#e9c46a'; // yellow
      case 'family': return '#264653'; // dark blue
      default: return '#0070cc';
    }
  }

  // Focus map on event marker and announce
  function focusMapOnEvent(eventId) {
    const event = eventsData.find(e => e.id === eventId);
    if (!event) return;
    focusedEventId = eventId;
    drawMap();
    mapLiveRegion.textContent = `Map focused on event: ${event.title} at ${event.location}. Date and time: ${formatEventDate(event.date)}.`;
  }

  // Reset filters
  function resetFilters() {
    filteredCategories.clear();
    const checkboxes = filterForm.querySelectorAll('input[type="checkbox"][name="category"]');
    checkboxes.forEach(cb => {
      cb.checked = false;
      cb.setAttribute('aria-checked', 'false');
    });
    renderEvents();
    focusedEventId = null;
    drawMap();
    mapLiveRegion.textContent = "Filters reset. Showing all events on map.";
  }

  // Handle filter changes
  function onFilterChange(e) {
    const target = e.target;
    if (target.name !== 'category') return;

    if (target.checked) {
      filteredCategories.add(target.value);
      target.setAttribute('aria-checked', 'true');
    } else {
      filteredCategories.delete(target.value);
      target.setAttribute('aria-checked', 'false');
    }
    renderEvents();
    focusedEventId = null;
    drawMap();
    mapLiveRegion.textContent = filteredCategories.size > 0
      ? `Filters applied: ${[...filteredCategories].join(', ')}. Map updated.`
      : "No filters applied. Showing all events on map.";
  }

  // Dropdown menu keyboard navigation
  function setupDropdownMenu() {
    const menuButton = categoriesMenuBtn;
    const menu = categoriesMenu;
    const menuItems = Array.from(menu.querySelectorAll('a[role="menuitem"]'));

    function openMenu() {
      menuButton.setAttribute('aria-expanded', 'true');
      menu.setAttribute('aria-hidden', 'false');
      menuItems.forEach(item => item.setAttribute('tabindex', '0'));
      menuItems[0].focus();
    }
    function closeMenu() {
      menuButton.setAttribute('aria-expanded', 'false');
      menu.setAttribute('aria-hidden', 'true');
      menuItems.forEach(item => item.setAttribute('tabindex', '-1'));
      menuButton.focus();
    }

    menuButton.addEventListener('click', () => {
      const expanded = menuButton.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    menuButton.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openMenu();
      }
    });

    menu.addEventListener('keydown', (e) => {
      const currentIndex = menuItems.indexOf(document.activeElement);
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        const nextIndex = (currentIndex + 1) % menuItems.length;
        menuItems[nextIndex].focus();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prevIndex = (currentIndex - 1 + menuItems.length) % menuItems.length;
        menuItems[prevIndex].focus();
      } else if (e.key === 'Home') {
        e.preventDefault();
        menuItems[0].focus();
      } else if (e.key === 'End') {
        e.preventDefault();
        menuItems[menuItems.length - 1].focus();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        closeMenu();
      } else if (e.key === 'Tab') {
        closeMenu();
      }
    });

    menuItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const category = item.dataset.category;
        if (category === 'all') {
          resetFilters();
        } else {
          // Check only the selected category and uncheck others
          filteredCategories.clear();
          filteredCategories.add(category);
          const checkboxes = filterForm.querySelectorAll('input[type="checkbox"][name="category"]');
          checkboxes.forEach(cb => {
            cb.checked = cb.value === category;
            cb.setAttribute('aria-checked', cb.checked ? 'true' : 'false');
          });
          renderEvents();
          focusedEventId = null;
          drawMap();
          mapLiveRegion.textContent = `Filter applied: ${category}. Map updated.`;
        }
        closeMenu();
      });
    });

    // Close menu if clicking outside
    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target) && e.target !== menuButton) {
        closeMenu();
      }
    });
  }

  // Accessibility: trap focus inside modal-like dropdown menu (optional)
  // Here dropdown is small, so no modal needed, but keyboard managed above.

  // Appearance customization
  function applyAppearance(foreground, background) {
    document.body.style.color = foreground;
    document.body.style.background = background;
    // Update header/nav/footer background for contrast
    document.querySelector('header').style.background = `linear-gradient(90deg, ${foreground}, ${background})`;
    document.querySelector('nav[aria-label="Primary"]').style.backgroundColor = foreground;
    document.querySelector('footer').style.backgroundColor = foreground;
    document.querySelector('footer').style.color = background;
  }

  // Validate appearance form (simple)
  function validateAppearanceForm() {
    const fg = foregroundSelect.value;
    const bg = backgroundSelect.value;
    if (fg === bg) {
      foregroundSelect.setAttribute('aria-invalid', 'true');
      backgroundSelect.setAttribute('aria-invalid', 'true');
      foregroundSelect.setCustomValidity('Text color and background color must not be the same.');
      backgroundSelect.setCustomValidity('Text color and background color must not be the same.');
      return false;
    } else {
      foregroundSelect.removeAttribute('aria-invalid');
      backgroundSelect.removeAttribute('aria-invalid');
      foregroundSelect.setCustomValidity('');
      backgroundSelect.setCustomValidity('');
      return true;
    }
  }

  // Initialize
  function init() {
    renderEvents();
    drawMap();
    setupDropdownMenu();

    // Event listeners
    filterForm.addEventListener('change', onFilterChange);
    resetFiltersBtn.addEventListener('click', resetFilters);

    // Appearance form
    appearanceForm.addEventListener('change', () => {
      if (validateAppearanceForm()) {
        applyAppearance(foregroundSelect.value, backgroundSelect.value);
      }
    });

    // Initial appearance application
    applyAppearance(foregroundSelect.value, backgroundSelect.value);

    // Keyboard accessibility enhancements for buttons and links
    // (Handled by browser defaults + focus styles)

    // Respect prefers-reduced-motion
    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    if (mediaQuery.matches) {
      // Disable any animations or transitions if added in future
      document.body.style.transition = 'none';
    }

    // Announce initial map loaded
    mapLiveRegion.textContent = "Map loaded. Showing all event venues.";
  }

  // On DOM ready
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>