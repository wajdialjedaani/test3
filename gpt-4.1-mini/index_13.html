<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Accessible Color Mixer & Theme Preview Tool</title>
<style>
  /* Reset and base */
  :root {
    --color-bg: #ffffff;
    --color-text: #1a1a1a;
    --color-primary: #005a9c;
    --color-primary-dark: #004080;
    --color-accent: #ff6f61;
    --color-accent-dark: #cc574d;
    --color-error: #b00020;
    --color-error-bg: #f9d6d5;
    --color-focus: #ffbf47;
    --color-border: #cccccc;
    --color-border-focus: #ffbf47;
    --font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    --font-size-base: 1rem;
    --font-size-large: 1.25rem;
    --line-height: 1.6;
    --spacing-base: 1rem;
    --spacing-small: 0.5rem;
    --min-touch-size: 44px;
  }
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.001ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.001ms !important;
      scroll-behavior: auto !important;
    }
  }
  html {
    font-size: 100%;
    scroll-behavior: smooth;
  }
  body {
    margin: 0;
    font-family: var(--font-family);
    font-size: var(--font-size-base);
    line-height: var(--line-height);
    color: var(--color-text);
    background: var(--color-bg);
    max-width: 80ch;
    padding: var(--spacing-base);
  }
  a {
    color: var(--color-primary);
    text-decoration: underline;
  }
  a:focus,
  button:focus,
  input:focus,
  select:focus,
  textarea:focus {
    outline: 3px solid var(--color-focus);
    outline-offset: 2px;
  }
  /* Skip link */
  #skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--color-primary);
    color: var(--color-bg);
    padding: 0.5rem 1rem;
    z-index: 100;
    font-weight: 700;
    border-radius: 0 0 4px 0;
  }
  #skip-link:focus {
    top: 0;
  }

  header, footer, main, nav, section, article {
    display: block;
  }

  header {
    border-bottom: 4px solid var(--color-primary);
    margin-bottom: var(--spacing-base);
  }
  header h1 {
    font-size: var(--font-size-large);
    margin: 0;
    padding: var(--spacing-small) 0;
  }
  nav[aria-label="Primary"] {
    margin-bottom: var(--spacing-base);
  }
  nav ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
    display: flex;
    gap: var(--spacing-base);
  }
  nav a {
    padding: 0.5rem 1rem;
    display: inline-block;
    border-radius: 4px;
    background: var(--color-primary);
    color: var(--color-bg);
    font-weight: 600;
  }
  nav a[aria-current="page"] {
    background: var(--color-accent);
    color: var(--color-bg);
  }
  nav a:focus-visible {
    outline-offset: 3px;
  }

  /* Breadcrumbs */
  nav[aria-label="Breadcrumb"] {
    font-size: 0.875rem;
    margin-bottom: var(--spacing-base);
  }
  nav[aria-label="Breadcrumb"] ol {
    list-style: none;
    padding-left: 0;
    margin: 0;
    display: flex;
    gap: 0.25rem;
  }
  nav[aria-label="Breadcrumb"] li::after {
    content: "â€º";
    margin-left: 0.25rem;
    color: var(--color-border);
  }
  nav[aria-label="Breadcrumb"] li:last-child::after {
    content: "";
  }
  nav[aria-label="Breadcrumb"] a {
    color: var(--color-primary);
    text-decoration: none;
  }
  nav[aria-label="Breadcrumb"] a:focus,
  nav[aria-label="Breadcrumb"] a:hover {
    text-decoration: underline;
  }

  main {
    margin-bottom: var(--spacing-base);
  }

  /* Layout */
  .container {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: var(--spacing-base);
  }
  @media (max-width: 768px) {
    .container {
      grid-template-columns: 1fr;
    }
  }

  /* Section headings */
  h2 {
    font-size: 1.5rem;
    margin-top: 0;
    margin-bottom: var(--spacing-small);
    border-bottom: 3px solid var(--color-primary);
    padding-bottom: 0.25rem;
  }
  h3 {
    font-size: 1.25rem;
    margin-top: var(--spacing-base);
    margin-bottom: var(--spacing-small);
  }

  /* Color Mixer Form */
  form {
    background: #f0f4f8;
    border-radius: 8px;
    padding: var(--spacing-base);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  fieldset {
    border: 2px solid var(--color-border);
    border-radius: 6px;
    padding: var(--spacing-base);
    margin-bottom: var(--spacing-base);
  }
  legend {
    font-weight: 700;
    font-size: 1.125rem;
    padding: 0 0.5rem;
    color: var(--color-primary-dark);
  }
  label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 600;
  }
  input[type="range"],
  input[type="number"] {
    width: 100%;
    margin-bottom: var(--spacing-small);
  }
  input[type="number"] {
    max-width: 6rem;
  }
  .input-group {
    margin-bottom: var(--spacing-base);
  }
  .input-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-small);
  }
  .input-row > label {
    flex: 1 0 3rem;
    margin-bottom: 0;
  }
  .input-row > input[type="range"] {
    flex: 3 1 auto;
  }
  .input-row > input[type="number"] {
    flex: 1 0 4rem;
  }

  /* Palette display */
  #palette-list {
    margin-top: var(--spacing-base);
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(100px,1fr));
    gap: var(--spacing-small);
  }
  .palette-swatch {
    border: 2px solid var(--color-border);
    border-radius: 6px;
    overflow: hidden;
    cursor: pointer;
    background: var(--color-bg);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    min-height: 100px;
  }
  .palette-swatch:focus-visible {
    outline: 3px solid var(--color-focus);
    outline-offset: 2px;
  }
  .palette-colors {
    display: flex;
    flex: 1 1 auto;
  }
  .palette-color {
    flex: 1 1 0;
    height: 30px;
  }
  .palette-label {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    background: var(--color-primary-dark);
    color: var(--color-bg);
    text-align: center;
    user-select: none;
  }

  /* Theme Preview */
  #theme-preview {
    border: 2px solid var(--color-border);
    border-radius: 8px;
    padding: var(--spacing-base);
    background: var(--color-bg);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  #theme-preview h3 {
    margin-top: 0;
  }
  .theme-sample {
    margin-top: var(--spacing-base);
    border-radius: 6px;
    padding: var(--spacing-base);
    color: var(--color-bg);
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .theme-light {
    background: linear-gradient(135deg, #fefefe 0%, #d6e4f0 100%);
    color: #1a1a1a;
  }
  .theme-dark {
    background: linear-gradient(135deg, #1a1a1a 0%, #3a3a3a 100%);
    color: #f0f0f0;
  }
  .theme-accent {
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
    color: var(--color-bg);
  }

  /* Buttons */
  button {
    background: var(--color-primary);
    color: var(--color-bg);
    border: none;
    border-radius: 6px;
    padding: 0.5rem 1rem;
    font-size: var(--font-size-base);
    font-weight: 600;
    cursor: pointer;
    min-width: var(--min-touch-size);
    min-height: var(--min-touch-size);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    user-select: none;
  }
  button:focus-visible {
    outline: 3px solid var(--color-focus);
    outline-offset: 2px;
  }
  button:disabled {
    background: var(--color-border);
    color: #666666;
    cursor: not-allowed;
  }

  /* Error message */
  .error-message {
    color: var(--color-error);
    background-color: var(--color-error-bg);
    border: 1px solid var(--color-error);
    border-radius: 4px;
    padding: 0.5rem;
    margin-top: 0.25rem;
    font-size: 0.875rem;
  }

  /* Visually hidden (for aria-live, labels) */
  .visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0,0,0,0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }

  /* Focus ring enhancement */
  :focus-visible {
    outline-offset: 3px;
    outline-width: 3px;
    outline-style: solid;
    outline-color: var(--color-focus);
  }

  /* Responsive and zoom support */
  @media (max-width: 480px) {
    body {
      padding: var(--spacing-small);
      max-width: 100%;
    }
  }
</style>
</head>
<body>
<a href="#main-content" id="skip-link">Skip to main content</a>

<header>
  <h1 id="page-title">Accessible Color Mixer &amp; Theme Preview Tool</h1>
  <nav aria-label="Primary">
    <ul>
      <li><a href="#color-mixer" aria-current="page">Color Mixer</a></li>
      <li><a href="#palette-section">Palettes</a></li>
      <li><a href="#theme-preview-section">Theme Preview</a></li>
      <li><a href="#help-section">Help</a></li>
    </ul>
  </nav>
  <nav aria-label="Breadcrumb">
    <ol>
      <li><a href="#page-title">Home</a></li>
      <li>Color Mixer</li>
    </ol>
  </nav>
</header>

<main id="main-content" tabindex="-1" aria-labelledby="page-title">
  <div class="container">
    <section id="color-mixer" aria-labelledby="color-mixer-heading">
      <h2 id="color-mixer-heading">Create Your Custom Color Palette</h2>
      <form id="color-mixer-form" novalidate aria-describedby="form-help" aria-live="polite">
        <fieldset>
          <legend>Color 1</legend>
          <div class="input-group">
            <div class="input-row">
              <label for="color1-red">Red</label>
              <input type="range" id="color1-red" name="color1-red" min="0" max="255" value="255" aria-describedby="color1-red-desc" required aria-required="true" />
              <input type="number" id="color1-red-num" name="color1-red-num" min="0" max="255" value="255" aria-label="Red value for Color 1" required aria-required="true" />
            </div>
            <div id="color1-red-desc" class="visually-hidden">Adjust the red component from 0 to 255</div>
          </div>
          <div class="input-group">
            <div class="input-row">
              <label for="color1-green">Green</label>
              <input type="range" id="color1-green" name="color1-green" min="0" max="255" value="0" aria-describedby="color1-green-desc" required aria-required="true" />
              <input type="number" id="color1-green-num" name="color1-green-num" min="0" max="255" value="0" aria-label="Green value for Color 1" required aria-required="true" />
            </div>
            <div id="color1-green-desc" class="visually-hidden">Adjust the green component from 0 to 255</div>
          </div>
          <div class="input-group">
            <div class="input-row">
              <label for="color1-blue">Blue</label>
              <input type="range" id="color1-blue" name="color1-blue" min="0" max="255" value="0" aria-describedby="color1-blue-desc" required aria-required="true" />
              <input type="number" id="color1-blue-num" name="color1-blue-num" min="0" max="255" value="0" aria-label="Blue value for Color 1" required aria-required="true" />
            </div>
            <div id="color1-blue-desc" class="visually-hidden">Adjust the blue component from 0 to 255</div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Color 2</legend>
          <div class="input-group">
            <div class="input-row">
              <label for="color2-red">Red</label>
              <input type="range" id="color2-red" name="color2-red" min="0" max="255" value="0" aria-describedby="color2-red-desc" required aria-required="true" />
              <input type="number" id="color2-red-num" name="color2-red-num" min="0" max="255" value="0" aria-label="Red value for Color 2" required aria-required="true" />
            </div>
            <div id="color2-red-desc" class="visually-hidden">Adjust the red component from 0 to 255</div>
          </div>
          <div class="input-group">
            <div class="input-row">
              <label for="color2-green">Green</label>
              <input type="range" id="color2-green" name="color2-green" min="0" max="255" value="0" aria-describedby="color2-green-desc" required aria-required="true" />
              <input type="number" id="color2-green-num" name="color2-green-num" min="0" max="255" value="0" aria-label="Green value for Color 2" required aria-required="true" />
            </div>
            <div id="color2-green-desc" class="visually-hidden">Adjust the green component from 0 to 255</div>
          </div>
          <div class="input-group">
            <div class="input-row">
              <label for="color2-blue">Blue</label>
              <input type="range" id="color2-blue" name="color2-blue" min="0" max="255" value="255" aria-describedby="color2-blue-desc" required aria-required="true" />
              <input type="number" id="color2-blue-num" name="color2-blue-num" min="0" max="255" value="255" aria-label="Blue value for Color 2" required aria-required="true" />
            </div>
            <div id="color2-blue-desc" class="visually-hidden">Adjust the blue component from 0 to 255</div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Color 3</legend>
          <div class="input-group">
            <div class="input-row">
              <label for="color3-red">Red</label>
              <input type="range" id="color3-red" name="color3-red" min="0" max="255" value="0" aria-describedby="color3-red-desc" required aria-required="true" />
              <input type="number" id="color3-red-num" name="color3-red-num" min="0" max="255" value="0" aria-label="Red value for Color 3" required aria-required="true" />
            </div>
            <div id="color3-red-desc" class="visually-hidden">Adjust the red component from 0 to 255</div>
          </div>
          <div class="input-group">
            <div class="input-row">
              <label for="color3-green">Green</label>
              <input type="range" id="color3-green" name="color3-green" min="0" max="255" value="255" aria-describedby="color3-green-desc" required aria-required="true" />
              <input type="number" id="color3-green-num" name="color3-green-num" min="0" max="255" value="255" aria-label="Green value for Color 3" required aria-required="true" />
            </div>
            <div id="color3-green-desc" class="visually-hidden">Adjust the green component from 0 to 255</div>
          </div>
          <div class="input-group">
            <div class="input-row">
              <label for="color3-blue">Blue</label>
              <input type="range" id="color3-blue" name="color3-blue" min="0" max="255" value="0" aria-describedby="color3-blue-desc" required aria-required="true" />
              <input type="number" id="color3-blue-num" name="color3-blue-num" min="0" max="255" value="0" aria-label="Blue value for Color 3" required aria-required="true" />
            </div>
            <div id="color3-blue-desc" class="visually-hidden">Adjust the blue component from 0 to 255</div>
          </div>
        </fieldset>

        <div class="input-group">
          <label for="palette-name">Palette Name <span aria-hidden="true" style="color: var(--color-error);">*</span></label>
          <input type="text" id="palette-name" name="palette-name" maxlength="30" autocomplete="off" required aria-required="true" aria-describedby="palette-name-help" />
          <div id="palette-name-help" class="visually-hidden">Enter a name for your custom palette, maximum 30 characters.</div>
          <div id="palette-name-error" class="error-message" role="alert" aria-live="assertive" hidden></div>
        </div>

        <button type="submit" id="save-palette-btn" aria-describedby="save-palette-desc" disabled>Save Palette</button>
        <div id="save-palette-desc" class="visually-hidden">Saves the current colors as a palette. Enabled when all inputs are valid.</div>
      </form>

      <section aria-label="Current Palette Preview" id="current-palette-preview" style="margin-top: var(--spacing-base);">
        <h3>Current Palette Preview</h3>
        <div id="current-palette" aria-live="polite" aria-atomic="true" role="region" aria-label="Live preview of current color palette">
          <!-- Color swatches inserted here -->
        </div>
      </section>
    </section>

    <aside id="palette-section" aria-labelledby="palette-section-heading" tabindex="0">
      <h2 id="palette-section-heading">Saved Palettes</h2>
      <p id="palette-count" aria-live="polite" aria-atomic="true" style="font-weight: 600;">No palettes saved yet.</p>
      <div id="palette-list" role="list" aria-label="List of saved color palettes">
        <!-- Saved palettes inserted here -->
      </div>
    </aside>
  </div>

  <section id="theme-preview-section" aria-labelledby="theme-preview-heading" tabindex="0" style="margin-top: var(--spacing-base);">
    <h2 id="theme-preview-heading">Real-Time Theme Preview</h2>
    <p id="theme-preview-desc">Preview how your palette colors apply to different design themes. Use keyboard to navigate and select palettes.</p>
    <div id="theme-preview" role="region" aria-live="polite" aria-atomic="true" aria-describedby="theme-preview-desc">
      <article class="theme-sample theme-light" tabindex="0" aria-label="Light theme preview sample">
        <h3>Light Theme</h3>
        <p>This theme uses your palette colors on a light background with high contrast text.</p>
        <button id="toggle-animation" aria-pressed="false" aria-label="Toggle animation for theme preview">Toggle Animation</button>
        <div id="light-theme-box" style="margin-top: 1rem; height: 100px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"></div>
      </article>
      <article class="theme-sample theme-dark" tabindex="0" aria-label="Dark theme preview sample" style="margin-top: var(--spacing-base);">
        <h3>Dark Theme</h3>
        <p>This theme uses your palette colors on a dark background with bright text.</p>
        <div id="dark-theme-box" style="margin-top: 1rem; height: 100px; border-radius: 8px; box-shadow: 0 4px 8px rgba(255,255,255,0.2);"></div>
      </article>
      <article class="theme-sample theme-accent" tabindex="0" aria-label="Accent theme preview sample" style="margin-top: var(--spacing-base);">
        <h3>Accent Theme</h3>
        <p>This theme highlights your palette colors as vibrant accents.</p>
        <div id="accent-theme-box" style="margin-top: 1rem; height: 100px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);"></div>
      </article>
    </div>
  </section>

  <section id="help-section" aria-labelledby="help-heading" tabindex="0" style="margin-top: var(--spacing-base);">
    <h2 id="help-heading">Help &amp; Instructions</h2>
    <article>
      <h3>How to Use the Color Mixer</h3>
      <p>Adjust the red, green, and blue sliders or number inputs for each color to create your custom palette. The preview updates live.</p>
      <p>Give your palette a unique name and click <strong>Save Palette</strong> to add it to your saved palettes list.</p>
    </article>
    <article>
      <h3>Using Saved Palettes</h3>
      <p>Click or keyboard select a saved palette to preview it in different design themes on the right. You can save multiple palettes and switch between them.</p>
    </article>
    <article>
      <h3>Accessibility Features</h3>
      <ul>
        <li>Full keyboard navigation and focus management.</li>
        <li>High contrast colors with a minimum 7:1 ratio for text.</li>
        <li>All interactive elements have labels and ARIA attributes.</li>
        <li>Reduced motion support and toggle for animations.</li>
        <li>Skip link for quick navigation to main content.</li>
      </ul>
    </article>
  </section>
</main>

<footer>
  <p>Â© 2024 Accessible Color Mixer Tool. Developed with full WCAG 2.2 AAA compliance.</p>
</footer>

<script>
  (() => {
    "use strict";

    // Utility: Clamp number between min and max
    const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

    // Elements
    const form = document.getElementById("color-mixer-form");
    const paletteNameInput = document.getElementById("palette-name");
    const paletteNameError = document.getElementById("palette-name-error");
    const saveButton = document.getElementById("save-palette-btn");
    const currentPaletteContainer = document.getElementById("current-palette");
    const paletteList = document.getElementById("palette-list");
    const paletteCount = document.getElementById("palette-count");

    // Theme preview boxes
    const lightThemeBox = document.getElementById("light-theme-box");
    const darkThemeBox = document.getElementById("dark-theme-box");
    const accentThemeBox = document.getElementById("accent-theme-box");

    // Animation toggle button
    const toggleAnimationBtn = document.getElementById("toggle-animation");

    // Reduced motion preference
    const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    // State
    let savedPalettes = [];
    let animationActive = !prefersReducedMotion;

    // Inputs grouped by color
    const colorInputs = [
      {
        red: document.getElementById("color1-red"),
        green: document.getElementById("color1-green"),
        blue: document.getElementById("color1-blue"),
        redNum: document.getElementById("color1-red-num"),
        greenNum: document.getElementById("color1-green-num"),
        blueNum: document.getElementById("color1-blue-num"),
      },
      {
        red: document.getElementById("color2-red"),
        green: document.getElementById("color2-green"),
        blue: document.getElementById("color2-blue"),
        redNum: document.getElementById("color2-red-num"),
        greenNum: document.getElementById("color2-green-num"),
        blueNum: document.getElementById("color2-blue-num"),
      },
      {
        red: document.getElementById("color3-red"),
        green: document.getElementById("color3-green"),
        blue: document.getElementById("color3-blue"),
        redNum: document.getElementById("color3-red-num"),
        greenNum: document.getElementById("color3-green-num"),
        blueNum: document.getElementById("color3-blue-num"),
      },
    ];

    // Synchronize range and number inputs bidirectionally
    function syncInputs(rangeInput, numberInput) {
      // When range changes, update number
      rangeInput.addEventListener("input", () => {
        numberInput.value = rangeInput.value;
        updateCurrentPalettePreview();
        validateForm();
      });
      // When number changes, update range (with validation)
      numberInput.addEventListener("input", () => {
        let val = parseInt(numberInput.value, 10);
        if (Number.isNaN(val)) {
          val = 0;
        }
        val = clamp(val, parseInt(numberInput.min, 10), parseInt(numberInput.max, 10));
        numberInput.value = val;
        rangeInput.value = val;
        updateCurrentPalettePreview();
        validateForm();
      });
      // Keyboard accessibility: prevent invalid input
      numberInput.addEventListener("keydown", (e) => {
        // Allow: backspace, delete, tab, arrows, home/end
        const allowedKeys = [
          "Backspace", "Delete", "Tab", "ArrowLeft", "ArrowRight", "Home", "End"
        ];
        if (
          allowedKeys.includes(e.key) ||
          (e.key >= "0" && e.key <= "9") ||
          (e.key === "Enter")
        ) {
          return;
        }
        e.preventDefault();
      });
    }

    // Setup synchronization for all inputs
    colorInputs.forEach(({red, green, blue, redNum, greenNum, blueNum}) => {
      syncInputs(red, redNum);
      syncInputs(green, greenNum);
      syncInputs(blue, blueNum);
    });

    // Convert RGB components to hex string (#RRGGBB)
    function rgbToHex(r, g, b) {
      const toHex = (c) => c.toString(16).padStart(2, "0").toUpperCase();
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }

    // Calculate relative luminance for contrast calculation
    // Formula from WCAG 2.2
    function relativeLuminance(r, g, b) {
      const srgb = [r, g, b].map(c => {
        const cs = c / 255;
        return cs <= 0.03928 ? cs / 12.92 : Math.pow((cs + 0.055) / 1.055, 2.4);
      });
      return 0.2126 * srgb[0] + 0.7152 * srgb[1] + 0.0722 * srgb[2];
    }

    // Calculate contrast ratio between two RGB colors
    function contrastRatio(rgb1, rgb2) {
      const L1 = relativeLuminance(rgb1[0], rgb1[1], rgb1[2]);
      const L2 = relativeLuminance(rgb2[0], rgb2[1], rgb2[2]);
      const lighter = Math.max(L1, L2);
      const darker = Math.min(L1, L2);
      return (lighter + 0.05) / (darker + 0.05);
    }

    // Check if contrast ratio meets AAA standard for normal text (7:1)
    function meetsContrastAAA(rgba1, rgba2) {
      return contrastRatio(rgba1, rgba2) >= 7;
    }

    // Validate palette name: non-empty, max 30 chars, no duplicate names
    function validatePaletteName(name) {
      if (!name.trim()) {
        return "Palette name is required.";
      }
      if (name.trim().length > 30) {
        return "Palette name must be 30 characters or less.";
      }
      if (savedPalettes.some(p => p.name.toLowerCase() === name.trim().toLowerCase())) {
        return "Palette name already exists. Please choose a unique name.";
      }
      return "";
    }

    // Validate entire form: colors in range and palette name valid
    function validateForm() {
      let valid = true;

      // Validate palette name
      const name = paletteNameInput.value;
      const nameError = validatePaletteName(name);
      if (nameError) {
        paletteNameError.textContent = nameError;
        paletteNameError.hidden = false;
        paletteNameInput.setAttribute("aria-invalid", "true");
        paletteNameInput.setAttribute("aria-describedby", "palette-name-error");
        valid = false;
      } else {
        paletteNameError.textContent = "";
        paletteNameError.hidden = true;
        paletteNameInput.removeAttribute("aria-invalid");
        paletteNameInput.removeAttribute("aria-describedby");
      }

      // Validate RGB inputs (0-255) - already constrained by input attributes and clamp
      for (const color of colorInputs) {
        for (const channel of ["red", "green", "blue"]) {
          const rangeInput = color[channel];
          const numInput = color[channel + "Num"];
          const rVal = parseInt(rangeInput.value, 10);
          const nVal = parseInt(numInput.value, 10);
          if (
            Number.isNaN(rVal) || Number.isNaN(nVal) ||
            rVal < 0 || rVal > 255 || nVal < 0 || nVal > 255 ||
            rVal !== nVal
          ) {
            valid = false;
            // For simplicity, we won't show per-channel errors, but disable save
          }
        }
      }

      saveButton.disabled = !valid;
      return valid;
    }

    // Generate current palette colors as array of RGB arrays
    function getCurrentPaletteColors() {
      return colorInputs.map(color => [
        parseInt(color.red.value, 10),
        parseInt(color.green.value, 10),
        parseInt(color.blue.value, 10),
      ]);
    }

    // Update live preview of current palette
    function updateCurrentPalettePreview() {
      const colors = getCurrentPaletteColors();
      currentPaletteContainer.innerHTML = "";

      colors.forEach((rgb, idx) => {
        const hex = rgbToHex(...rgb);
        const swatch = document.createElement("div");
        swatch.className = "palette-swatch";
        swatch.setAttribute("role", "img");
        swatch.setAttribute("aria-label", `Color ${idx + 1}: ${hex} with RGB values ${rgb.join(", ")}`);
        swatch.style.borderColor = "#666666";
        const colorDiv = document.createElement("div");
        colorDiv.className = "palette-color";
        colorDiv.style.backgroundColor = hex;
        // Add pattern for color blindness support (diagonal stripes) if color is low contrast
        if (!meetsContrastAAA(rgb, [255, 255, 255]) && !meetsContrastAAA(rgb, [0, 0, 0])) {
          colorDiv.style.backgroundImage = `repeating-linear-gradient(
            45deg,
            transparent,
            transparent 4px,
            rgba(255,255,255,0.3) 4px,
            rgba(255,255,255,0.3) 8px
          )`;
        }
        swatch.appendChild(colorDiv);
        const label = document.createElement("div");
        label.className = "palette-label";
        label.textContent = hex;
        swatch.appendChild(label);
        currentPaletteContainer.appendChild(swatch);
      });
    }

    // Save palette to state and update UI
    function savePalette(name, colors) {
      savedPalettes.push({ name: name.trim(), colors });
      updatePaletteList();
      paletteNameInput.value = "";
      saveButton.disabled = true;
      paletteNameInput.focus();
      announce(`Palette "${name}" saved successfully.`);
    }

    // Update saved palettes list UI
    function updatePaletteList() {
      paletteList.innerHTML = "";
      if (savedPalettes.length === 0) {
        paletteCount.textContent = "No palettes saved yet.";
        return;
      }
      paletteCount.textContent = `${savedPalettes.length} palette${savedPalettes.length === 1 ? "" : "s"} saved.`;

      savedPalettes.forEach((palette, index) => {
        const item = document.createElement("div");
        item.className = "palette-swatch";
        item.tabIndex = 0;
        item.setAttribute("role", "listitem");
        item.setAttribute("aria-label", `Saved palette: ${palette.name}. Press Enter or Space to preview.`);
        item.dataset.index = index;

        const colorsDiv = document.createElement("div");
        colorsDiv.className = "palette-colors";

        palette.colors.forEach(rgb => {
          const colorDiv = document.createElement("div");
          colorDiv.className = "palette-color";
          const hex = rgbToHex(...rgb);
          colorDiv.style.backgroundColor = hex;
          // Add pattern if low contrast for accessibility
          if (!meetsContrastAAA(rgb, [255, 255, 255]) && !meetsContrastAAA(rgb, [0, 0, 0])) {
            colorDiv.style.backgroundImage = `repeating-linear-gradient(
              45deg,
              transparent,
              transparent 4px,
              rgba(255,255,255,0.3) 4px,
              rgba(255,255,255,0.3) 8px
            )`;
          }
          colorsDiv.appendChild(colorDiv);
        });

        item.appendChild(colorsDiv);

        const label = document.createElement("div");
        label.className = "palette-label";
        label.textContent = palette.name;
        item.appendChild(label);

        // Keyboard and mouse handlers for selecting palette
        item.addEventListener("click", () => {
          previewPalette(index);
        });
        item.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            previewPalette(index);
          }
        });

        paletteList.appendChild(item);
      });
    }

    // Announce messages for screen readers
    function announce(message) {
      let liveRegion = document.getElementById("aria-live-region");
      if (!liveRegion) {
        liveRegion = document.createElement("div");
        liveRegion.id = "aria-live-region";
        liveRegion.className = "visually-hidden";
        liveRegion.setAttribute("aria-live", "polite");
        liveRegion.setAttribute("aria-atomic", "true");
        document.body.appendChild(liveRegion);
      }
      liveRegion.textContent = message;
    }

    // Preview palette in theme previews
    function previewPalette(index) {
      const palette = savedPalettes[index];
      if (!palette) return;

      // Use palette colors to style theme preview boxes:
      // Light theme: background gradient from color1 to color2, text color color3 or black/white depending on contrast
      const [c1, c2, c3] = palette.colors;
      const c1Hex = rgbToHex(...c1);
      const c2Hex = rgbToHex(...c2);
      const c3Hex = rgbToHex(...c3);

      // Light theme background gradient
      lightThemeBox.style.background = `linear-gradient(135deg, ${c1Hex} 0%, ${c2Hex} 100%)`;

      // Determine best text color for light theme (c3 or black/white)
      const black = [0, 0, 0];
      const white = [255, 255, 255];
      let lightTextColor = c3;
      // Ensure text contrast on light background is >=7:1
      if (!meetsContrastAAA(c3, c1) || !meetsContrastAAA(c3, c2)) {
        // Fallback to black or white whichever has better contrast
        const blackContrast = Math.min(contrastRatio(black, c1), contrastRatio(black, c2));
        const whiteContrast = Math.min(contrastRatio(white, c1), contrastRatio(white, c2));
        lightTextColor = blackContrast >= whiteContrast ? black : white;
      }
      lightThemeBox.style.color = rgbToHex(...lightTextColor);

      // Dark theme background gradient (inverse colors)
      darkThemeBox.style.background = `linear-gradient(135deg, ${c2Hex} 0%, ${c1Hex} 100%)`;

      // Dark theme text color: use c3 or white/black for contrast
      let darkTextColor = c3;
      if (!meetsContrastAAA(c3, c2) || !meetsContrastAAA(c3, c1)) {
        const blackContrast = Math.min(contrastRatio(black, c2), contrastRatio(black, c1));
        const whiteContrast = Math.min(contrastRatio(white, c2), contrastRatio(white, c1));
        darkTextColor = whiteContrast >= blackContrast ? white : black;
      }
      darkThemeBox.style.color = rgbToHex(...darkTextColor);

      // Accent theme: solid background color c3, text color black or white for contrast
      accentThemeBox.style.background = c3Hex;
      const blackContrastAccent = contrastRatio(black, c3);
      const whiteContrastAccent = contrastRatio(white, c3);
      accentThemeBox.style.color = whiteContrastAccent >= blackContrastAccent ? rgbToHex(...white) : rgbToHex(...black);

      announce(`Previewing palette "${palette.name}" in theme previews.`);
    }

    // Animate light theme box background colors if animation enabled
    let animationFrameId = null;
    let animationStep = 0;
    function animateLightTheme() {
      if (!animationActive) return;
      animationStep += 0.01;
      if (animationStep > 1) animationStep = 0;
      const colors = getCurrentPaletteColors();
      if (colors.length < 2) return;
      const c1 = colors[0];
      const c2 = colors[1];

      // Linear interpolation between c1 and c2
      const lerp = (start, end, t) => Math.round(start + (end - start) * t);
      const r = lerp(c1[0], c2[0], animationStep);
      const g = lerp(c1[1], c2[1], animationStep);
      const b = lerp(c1[2], c2[2], animationStep);
      const hex = rgbToHex(r, g, b);
      lightThemeBox.style.background = `linear-gradient(135deg, ${hex} 0%, ${rgbToHex(...c2)} 100%)`;

      animationFrameId = requestAnimationFrame(animateLightTheme);
    }

    // Toggle animation button handler
    toggleAnimationBtn.addEventListener("click", () => {
      animationActive = !animationActive;
      toggleAnimationBtn.setAttribute("aria-pressed", animationActive.toString());
      toggleAnimationBtn.textContent = animationActive ? "Pause Animation" : "Play Animation";
      if (animationActive) {
        animateLightTheme();
      } else {
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
          animationFrameId = null;
        }
        // Reset to static preview
        const colors = getCurrentPaletteColors();
        if (colors.length >= 2) {
          lightThemeBox.style.background = `linear-gradient(135deg, ${rgbToHex(...colors[0])} 0%, ${rgbToHex(...colors[1])} 100%)`;
        }
      }
    });

    // Form submit handler
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!validateForm()) {
        paletteNameInput.focus();
        return;
      }
      const name = paletteNameInput.value;
      const colors = getCurrentPaletteColors();
      savePalette(name, colors);
    });

    // Initialize preview on page load
    updateCurrentPalettePreview();

    // Validate form on load and input
    validateForm();

    // Preview first palette if exists
    function previewFirstPalette() {
      if (savedPalettes.length > 0) {
        previewPalette(0);
      }
    }

    // Keyboard shortcut for skip link focus (for testing)
    // No trap in keyboard navigation, focus visible by default

    // Initial theme preview uses current palette colors
    previewPalette(-1); // no saved palette, preview current colors

    // When palette list changes, preview first palette automatically
    // But only if no palette selected yet
    // We implement preview on savePalette already

    // Accessibility: Focus management on skip link
    const skipLink = document.getElementById("skip-link");
    skipLink.addEventListener("click", (e) => {
      const main = document.getElementById("main-content");
      main.focus();
    });

    // When user changes any color input, update current palette preview and theme previews
    colorInputs.forEach(color => {
      ["red", "green", "blue"].forEach(channel => {
        color[channel].addEventListener("input", () => {
          updateCurrentPalettePreview();
          validateForm();
          // Update theme previews only if no saved palette selected (preview current colors)
          // We consider current colors as index -1
          previewPalette(-1);
        });
      });
    });

    // Support previewPalette with index -1 = current colors
    function previewPalette(index) {
      let palette;
      if (index === -1) {
        palette = { name: "Current Colors", colors: getCurrentPaletteColors() };
      } else {
        palette = savedPalettes[index];
        if (!palette) return;
      }

      const [c1, c2, c3] = palette.colors;
      const c1Hex = rgbToHex(...c1);
      const c2Hex = rgbToHex(...c2);
      const c3Hex = rgbToHex(...c3);

      lightThemeBox.style.background = `linear-gradient(135deg, ${c1Hex} 0%, ${c2Hex} 100%)`;
      let black = [0, 0, 0];
      let white = [255, 255, 255];

      let lightTextColor = c3;
      if (!meetsContrastAAA(c3, c1) || !meetsContrastAAA(c3, c2)) {
        const blackContrast = Math.min(contrastRatio(black, c1), contrastRatio(black, c2));
        const whiteContrast = Math.min(contrastRatio(white, c1), contrastRatio(white, c2));
        lightTextColor = blackContrast >= whiteContrast ? black : white;
      }
      lightThemeBox.style.color = rgbToHex(...lightTextColor);

      darkThemeBox.style.background = `linear-gradient(135deg, ${c2Hex} 0%, ${c1Hex} 100%)`;
      let darkTextColor = c3;
      if (!meetsContrastAAA(c3, c2) || !meetsContrastAAA(c3, c1)) {
        const blackContrast = Math.min(contrastRatio(black, c2), contrastRatio(black, c1));
        const whiteContrast = Math.min(contrastRatio(white, c2), contrastRatio(white, c1));
        darkTextColor = whiteContrast >= blackContrast ? white : black;
      }
      darkThemeBox.style.color = rgbToHex(...darkTextColor);

      accentThemeBox.style.background = c3Hex;
      const blackContrastAccent = contrastRatio(black, c3);
      const whiteContrastAccent = contrastRatio(white, c3);
      accentThemeBox.style.color = whiteContrastAccent >= blackContrastAccent ? rgbToHex(...white) : rgbToHex(...black);

      if (index >= 0) {
        announce(`Previewing palette "${palette.name}" in theme previews.`);
      } else {
        announce("Previewing current colors in theme previews.");
      }
    }

    // On page load, preview current colors
    previewPalette(-1);

    // Animate light theme box if animation enabled
    if (animationActive) {
      animateLightTheme();
      toggleAnimationBtn.setAttribute("aria-pressed", "true");
      toggleAnimationBtn.textContent = "Pause Animation";
    } else {
      toggleAnimationBtn.setAttribute("aria-pressed", "false");
      toggleAnimationBtn.textContent = "Play Animation";
    }

  })();
</script>
</body>
</html>